<div class="flex h-full w-full flex-col">
  @if (showToolbar()) {
  <pc-dg-toolbar
    [addRoute]="addRoute()"
    [plusIcon]="plusIcon()"
    [disableRefresh]="disableRefresh()"
    [allowFilter]="allowFilter()"
    [canUndo]="!!undoMgr.canUndo()"
    [canRedo]="!!undoMgr.canRedo()"
    [disableDelete]="disableDelete()"
    [hasSelection]="hasSelection()"
    [disableImport]="disableImport()"
    [disableExport]="disableExport()"
    [showFilters]="showFilters()"
    [showArchiveIcon]="showArchiveIcon()"
    [archiveMode]="archiveMode()"
    [colDefs]="colDefsWithEdit"
    [colVisibilityMap]="colVisibility()"
    (add)="add()"
    (refresh)="refresh()"
    (undo)="undoMgr.undo()"
    (redo)="undoMgr.redo()"
    (deleteSelected)="confirmDelete()"
    (importCsv)="doImportCSV()"
    (exportCsv)="confirmExport()"
    (toggleFilters)="filter()"
    (showAllCols)="showAllCols()"
    (hideAllCols)="hideAllCols()"
    (resetAllWidths)="resetAllWidths()"
    (toggleArchive)="toggleArchiveMode()"
    (toggleCol)="toggleCol($event.field, $event.checked)"
  />
  } @if (isLoading()) {
  <progress class="progress h-1"></progress>
  } @if (isPageFullySelected() && displayedCount() < totalCountAll()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ displayedCount() }} rows on this page are selected.</span>
    <a class="link hover:no-underline" (click)="selectAllMatching()">Select all {{ totalCountAll() }} rows</a>
  </div>
  } @if (allSelected()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ allSelectedCount() || totalCountAll() }} rows are selected.</span>
    <a class="link hover:no-underline" (click)="clearAllSelection()">Clear selection</a>
  </div>
  }
  <div #scroller class="flex-1 overflow-auto border border-base-300 rounded" (scroll)="onScroll($event)">
    <table #gridTable class="table table-zebra table-fixed w-full">
      <thead class="sticky top-0 bg-base-100 z-10">
        <pc-dg-header
          [groups]="headerGroups()"
          [enableSelection]="enableSelection()"
          [selectionStickyWidth]="selectionStickyWidth()"
          [allSelected]="allSelected()"
          [tableAllPageSelected]="tableAllPageSelectedFn"
          [tableSomePageSelected]="tableSomePageSelectedFn"
          [onHeaderCheckbox]="onHeaderCheckboxFn"
          [onSelectionResizeMouseDown]="onSelectionResizeMouseDownFn"
          [onSelectionResizeTouchStart]="onSelectionResizeTouchStartFn"
          [onSelectionResizeDragStart]="onSelectionResizeDragStartFn"
          [toggleHeaderSort]="toggleHeaderSortFn"
          [onHeaderDragStart]="onHeaderDragStartFn"
          [onHeaderDragOver]="onHeaderDragOverFn"
          [onHeaderDrop]="onHeaderDropFn"
          [requestPersist]="requestPersistFn"
          [ariaSortHeader]="ariaSortHeaderFn"
          [pinState]="pinStateHFn"
          [leftOffsetPx]="leftOffsetPxFn"
          [rightOffsetPx]="rightOffsetPxFn"
          [getColWidth]="getColWidthFn"
          [sortIndicatorForHeader]="sortIndicatorForHeaderFn"
          [getColDefById]="getColDefByIdFn"
          [getFilterOptionsForCol]="getFilterOptionsForColFn"
          [isOptionChecked]="isOptionCheckedFn"
          [onToggleFilterOption]="onToggleFilterOptionFn"
          [clearHeaderFilter]="clearHeaderFilterFn"
          [getFilterValue]="getFilterValueFn"
          [onHeaderFilterInput]="onHeaderFilterInputFn"
          [sortAsc]="sortAscFn"
          [sortDesc]="sortDescFn"
          [clearSort]="clearSortFn"
          [pinLeft]="pinLeftFn"
          [pinRight]="pinRightFn"
          [unpin]="unpinFn"
          [autoSizeColumn]="autoSizeColumnFn"
          [resetColWidth]="resetColWidthFn"
          [hideColumn]="hideColumnFn"
          [showColumnById]="showColumnByIdFn"
          [columnLabelFor]="columnLabelForFn"
          [hiddenColumns]="hiddenColumns()"
        />
        @if (showFilters()) {
          <pc-dg-inline-filters-row
            [enableSelection]="enableSelection()"
            [selectionStickyWidth]="selectionStickyWidth()"
            [leafHeaders]="leafHeaders()"
            [getColDefById]="inlineGetColDefByIdFn"
            [getFilterOptionsForCol]="inlineGetFilterOptionsForColFn"
            [inlineFilterLabel]="inlineFilterLabelFn"
            [isOptionChecked]="inlineIsOptionCheckedFn"
            [onToggleFilterOption]="inlineOnToggleFilterOptionFn"
            [onHeaderFilterInput]="inlineOnHeaderFilterInputFn"
            [clearHeaderFilter]="inlineClearHeaderFilterFn"
            [getFilterValue]="inlineGetFilterValueFn"
          />
        }
      </thead>
      <tbody>
        <!-- top spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding: 0">
            <div [style.height.px]="topPadHeight()"></div>
          </td>
        </tr>
        @for (r of visibleTableRows(); track r.id) {
        <tr (mouseover)="onCellMouseOver(r.original)" [attr.data-row-id]="toId(r.original)">
          @if (enableSelection()) {
          <td class="sticky left-0 z-20 bg-base-100" [style.width.px]="selectionStickyWidth()">
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="allSelected() ? allSelectedIdSet.has(toId(r.original)) : r.getIsSelected()"
              (change)="onRowCheckboxChange(r, $any($event.target).checked)"
            />
          </td>
          } @for (cell of r.getVisibleCells(); track cell.id) { @let col = getColDefById(cell.column.id); @if (col &&
          isColVisible(col)) {
          <td
            [pcEditable]="editableCfg(r.original, col)"
            tabindex="0"
            (keydown)="onCellKeydown($event)"
            [class.sticky]="pinState(cell) !== false"
            [style.left.px]="pinState(cell) === 'left' ? leftOffsetPx(cell.column.id) : null"
            [style.right.px]="pinState(cell) === 'right' ? rightOffsetPx(cell.column.id) : null"
            [style.background]="pinState(cell) !== false ? 'var(--fallback-b1,oklch(var(--b1)))' : null"
            [style.zIndex]="pinState(cell) !== false ? 10 : null"
            [style.width.px]="getColWidth(cell.column.id) || null"
            class="overflow-hidden min-w-0 px-0"
            [attr.data-col-id]="cell.column.id"
          >
            @let ec = editingCell(); @if (ec && ec.id === toId(r.original) && ec.field === col.field) { @let opts =
            getFilterOptionsForCol(col); @if (opts?.length) {
            <select
              class="select select-bordered select-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              autofocus
            >
              @for (o of opts; track o) {
              <option [value]="o">{{ o }}</option>
              }
            </select>
            } @else {
            <input
              [type]="inputTypeFor(col)"
              class="input input-bordered input-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              autofocus
            />
            } } @else if (hasCellRenderer(col)) {
            <span [innerHTML]="callCellRenderer(r.original, col)"></span>
            } @else if (col.valueFormatter) { {{ callValueFormatter(r.original, col) }} } @else { {{
            getCellValue(r.original, col) }} }
          </td>
          } }
        </tr>
        }
        <!-- bottom spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding: 0">
            <div [style.height.px]="bottomPadHeight()"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="flex items-center justify-between mt-2">
    <div class="text-sm">Page {{ pageIndex() + 1 }} of {{ totalPages() }} ({{ totalCountAll() }} rows)</div>
    <div class="join">
      <button class="btn btn-sm join-item" [disabled]="!canPrev()" (click)="prevPage()">Prev</button>
      <button class="btn btn-sm join-item" [disabled]="!canNext()" (click)="nextPage()">Next</button>
    </div>
  </div>
  @if (isLoading()) {
  <pc-icon name="loading" class="absolute inset-0 grid place-items-center animate-pulse" [size]="24"></pc-icon>
  }
</div>

<!-- Right-side Filter Panel -->
@if (showFilterPanel()) {
  <pc-dg-filter-panel
    [panelFields]="panelFields()"
    [panelFilters]="panelFilters()"
    [labelFor]="labelForFn"
    [optionsFor]="optionsForFn"
    (close)="closePanel()"
    (apply)="applyPanelFilters()"
    (clear)="clearPanelFilters()"
    (changeOp)="onPanelOpChange($event.field, $event.op)"
    (changeValue)="onPanelValueChange($event.field, $event.value)"
  />
}

<div class="flex h-full w-full flex-col">
  @if (showToolbar()) { <pc-dg-toolbar /> } @if (isLoading()) {
  <progress class="progress h-1"></progress>
  } @if (isPageFullySelected() && displayedCount() < totalCountAll()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ displayedCount() }} rows on this page are selected.</span>
    <a class="link hover:no-underline" (click)="selectAllMatching()">Select all {{ totalCountAll() }} rows</a>
  </div>
  } @if (allSelected()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ allSelectedCount() || totalCountAll() }} rows are selected.</span>
    <a class="link hover:no-underline" (click)="clearAllSelection()">Clear selection</a>
  </div>
  }
  <div #scroller class="flex-1 overflow-auto border border-base-300 rounded" (scroll)="onScroll($event)">
    <table #gridTable class="table w-full">
      <thead>
        <tr>
          @if (enableSelection()) {
          <th class="border-r border-base-300 pl-2">
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="!allSelected() && tableAllPageSelected()"
              [indeterminate]="!allSelected() && tableSomePageSelected()"
              (change)="onHeaderCheckbox($any($event.target).checked)"
            />
          </th>
          } @for (h of leafHeaders(); track h.id) {
          <th
            role="columnheader"
            class="cursor-pointer border-r border-base-300 pl-2"
            [attr.aria-sort]="ariaSortHeader(h)"
            [draggable]="true"
            (dragstart)="onHeaderDragStart(h, $event)"
            (dragover)="onHeaderDragOver(h, $event)"
            (drop)="onHeaderDrop(h, $event)"
          >
            <div class="flex items-center gap-2">
              <span class="flex-grow" (click)="toggleHeaderSort(h, $event)">
                {{ h.column?.columnDef?.header || h.column?.id }}
              </span>
              <pc-icon [name]="sortIndicatorForHeader(h)" [size]="4"></pc-icon>
              <div class="dropdown dropdown-end" (click)="$event.stopPropagation()">
                <label tabindex="0" class="btn btn-ghost btn-xs" title="Column options">
                  <pc-icon name="ellipsis-vertical"></pc-icon>
                </label>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-60 p-2 shadow">
                  @let col = getColDefById(h.column.id);
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Filter</span><span>▸</span></label
                    >
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-64 p-2 shadow">
                      @if (col && getFilterOptionsForCol(col)?.length) { @for (opt of getFilterOptionsForCol(col)!;
                      track opt) {
                      <li>
                        <label class="label cursor-pointer justify-start gap-2 px-2 py-1">
                          <input
                            type="checkbox"
                            class="checkbox checkbox-xs"
                            [checked]="isOptionChecked(h.column.id, opt)"
                            (change)="onToggleFilterOption(h.column.id, opt, $any($event.target).checked)"
                          />
                          <span class="label-text">{{ opt }}</span>
                        </label>
                      </li>
                      }
                      <li class="px-2 pt-1"><a (click)="clearHeaderFilter(h.column.id)">Clear</a></li>
                      } @else {
                      <li class="px-2 py-1">
                        <input
                          class="input input-bordered input-xs w-full"
                          type="text"
                          placeholder="Filter value"
                          [value]="getFilterValue(h.column.id)"
                          (input)="onHeaderFilterInput(h.column.id, $any($event.target).value)"
                        />
                      </li>
                      <li class="px-2 pt-1"><a (click)="clearHeaderFilter(h.column.id)">Clear</a></li>
                      }
                    </ul>
                  </li>
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Sort</span><span>▸</span></label
                    >
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-48 p-2 shadow">
                      <li><a (click)="sortAsc(h)">Sort asc</a></li>
                      <li><a (click)="sortDesc(h)">Sort desc</a></li>
                      <li><a (click)="clearSort(h)">Clear sort</a></li>
                    </ul>
                  </li>
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Column</span><span>▸</span></label
                    >
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-64 p-2 shadow">
                      <li><a (click)="hideColumn(h)">Hide</a></li>
                      <li class="dropdown dropdown-right">
                        <label tabindex="0" class="flex w-full items-center justify-between"
                          ><span>Columns</span><span>▸</span></label
                        >
                        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-64 p-2 shadow">
                          @for (cid of hiddenColumns(); track cid) {
                          <li><a (click)="showColumnById(cid)">Show {{ columnLabelFor(cid) }}</a></li>
                          } @if (!hiddenColumns().length) {
                          <li class="opacity-60 px-2 py-1">None hidden</li>
                          }
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </th>
          }
        </tr>
      </thead>
      <tbody class="bg-base-100">
        @for (r of visibleTableRows(); let i = $index; track r.id) {
        <tr
          (mouseover)="onCellMouseOver(r.original)"
          [attr.data-row-id]="toId(r.original)"
          [class.bg-base-200]="(i % 2) === 1"
        >
          @if (enableSelection()) {
          <td class="sticky left-0 z-20 border-r border-base-300 pl-2" [style.background]="rowBgForIndex(i)">
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="allSelected() ? allSelectedIdSet.has(toId(r.original)) : r.getIsSelected()"
              (change)="onRowCheckboxChange(r, $any($event.target).checked)"
            />
          </td>
          } @for (cell of r.getVisibleCells(); track cell.id) { @let col = getColDefById(cell.column.id); @if (col &&
          isColVisible(col)) {
          <td
            [pcEditable]="editableCfg(r.original, col)"
            tabindex="0"
            (keydown)="onCellKeydown($event)"
            (dblclick)="handleCellDblClick(r.original, col)"
            [class.sticky]="pinState(cell) !== false"
            [style.left.px]="pinState(cell) === 'left' ? leftOffsetPx(cell.column.id) : null"
            [style.right.px]="pinState(cell) === 'right' ? rightOffsetPx(cell.column.id) : null"
            [style.background]="pinState(cell) !== false ? rowBgForIndex(i) : null"
            [style.zIndex]="pinState(cell) !== false ? 10 : null"
            class="overflow-hidden min-w-0 px-0 border-r border-base-300 pl-2"
            [attr.data-col-id]="cell.column.id"
          >
            @let ec = editingCell(); @if (ec && ec.id === toId(r.original) && ec.field === col.field) { @let opts =
            getFilterOptionsForCol(col); @if (opts?.length) {
            <select
              class="select select-bordered select-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              autofocus
            >
              @for (o of opts; track o) {
              <option [value]="o">{{ o }}</option>
              }
            </select>
            } @else {
            <input
              [type]="inputTypeFor(col)"
              class="input input-bordered input-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              autofocus
            />
            } } @else if (hasCellRenderer(col)) {
            <span [innerHTML]="callCellRenderer(r.original, col)"></span>
            } @else if (col.valueFormatter) { {{ callValueFormatter(r.original, col) }} } @else { {{
            getCellValue(r.original, col) }} }
          </td>
          } }
        </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="flex items-center justify-end mt-2 gap-3 text-xs flex-nowrap">
    <div class="flex items-center gap-2 whitespace-nowrap">
      <span class="whitespace-nowrap">Page Size:</span>
      <select
        class="select select-bordered select-xs"
        [ngModel]="pageSize()"
        (ngModelChange)="onPageSizeChange($event)"
      >
        @if (![25,50,100].includes(pageSize())) {
        <option [value]="pageSize()">{{ pageSize() }}</option>
        } @for (opt of pageSizeChoices(); track opt) {
        <option [value]="opt">{{ opt }}</option>
        }
      </select>
    </div>
    <div class="whitespace-nowrap">
      <span class="font-normal">{{ displayStartIndex() }}</span> to
      <span class="font-normal">{{ displayEndIndex() }}</span> of
      <span class="font-normal">{{ totalCountAll() }}</span>
    </div>
    <div class="join whitespace-nowrap">
      <button
        class="btn btn-sm font-light join-item btn-ghost"
        title="First"
        [disabled]="!canPrev()"
        (click)="firstPage()"
      >
        |&lt;
      </button>
      <button
        class="btn btn-sm font-light join-item btn-ghost"
        title="Prev"
        [disabled]="!canPrev()"
        (click)="prevPage()"
      >
        &lt;
      </button>
      <button class="btn font-light btn-sm join-item btn-ghost pointer-events-none whitespace-nowrap">
        Page <span class="font-normal">{{ pageIndex() + 1 }}</span> of
        <span class="font-normal">{{ totalPages() }}</span>
      </button>
      <button
        class="btn btn-sm font-light join-item btn-ghost"
        title="Next"
        [disabled]="!canNext()"
        (click)="nextPage()"
      >
        &gt;
      </button>
      <button
        class="btn btn-sm font-light join-item btn-ghost"
        title="Last"
        [disabled]="!canNext()"
        (click)="lastPage()"
      >
        &gt;|
      </button>
    </div>
  </div>
  @if (isLoading()) {
  <pc-icon name="loading" class="absolute inset-0 grid place-items-center animate-pulse" [size]="24"></pc-icon>
  }
</div>

<!-- Right-side Filter Panel -->
@if (showFilterPanel()) {
<pc-dg-filter-panel
  [panelFields]="panelFields()"
  [panelFilters]="panelFilters()"
  [labelFor]="labelForFn"
  [optionsFor]="optionsForFn"
  (close)="closePanel()"
  (apply)="applyPanelFilters()"
  (clear)="clearPanelFilters()"
  (changeOp)="onPanelOpChange($event.field, $event.op)"
  (changeValue)="onPanelValueChange($event.field, $event.value)"
/>
}

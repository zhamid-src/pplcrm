<div class="flex h-full w-full flex-col">
  @if (showToolbar()) {
  <ul class="menu menu-horizontal flex flex-row pt-0">
    <pc-grid-action [enabled]="!!addRoute()" [tip]="'Add'" [icon]="plusIcon()" (action)="add()" />
    <pc-grid-action [enabled]="!disableRefresh()" [tip]="'Refresh the grid'" icon="arrow-path" (action)="refresh()" />
    <pc-grid-action [enabled]="!!undoMgr.canUndo()" [tip]="'Undo'" icon="arrow-uturn-left" (action)="undoMgr.undo()" />
    <pc-grid-action [enabled]="!!undoMgr.canRedo()" [tip]="'Redo'" icon="arrow-uturn-right" (action)="undoMgr.redo()" />
    <pc-grid-action [enabled]="canMerge()" [tip]="'Merge'" icon="merge" (action)="merge()"></pc-grid-action>
    <pc-grid-action
      [enabled]="!disableImport()"
      [tip]="'Import data from CSV'"
      icon="cloud-arrow-up"
      (action)="doImportCSV()"
    />

    <pc-grid-action
      [enabled]="!disableExport()"
      [tip]="'Download as CSV'"
      icon="arrow-down-tray"
      (action)="confirmExport()"
    />
    <pc-grid-action
      [enabled]="!disableDelete() && isRowSelected()"
      [tip]="'Deleted selected row(s)'"
      icon="trash"
      (action)="confirmDelete()"
    />
    <pc-grid-action icon="funnel" tip="Filter the grid" (action)="filter()" />
    <pc-grid-action
      icon="archive-box"
      tip="See archived tasks"
      [hidden]="!showArchiveIcon()"
      [active]="archiveMode()"
      (action)="toggleArchiveMode()"
    />
    <li class="grow">
      <a class="hover:text-primary ml-auto">
        <pc-icon name="information-circle"></pc-icon>
      </a>
    </li>
  </ul>
  } @if (isLoading()) {
  <progress class="progress h-1"></progress>
  } @if (isPageFullySelected() && getDisplayedCount() < totalCountAll) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ getDisplayedCount() }} rows on this page are selected.</span>
    <a class="link hover:no-underline" (click)="selectAllMatching()">Select all {{ totalCountAll }} rows</a>
  </div>
  } @if (allSelected()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ allSelectedCount || totalCountAll }} rows are selected.</span>
    <a class="link hover:no-underline" (click)="clearAllSelection()">Clear selection</a>
  </div>
  }
  <div #scroller class="flex-1 overflow-auto border border-base-300 rounded" (scroll)="onScroll($event)">
    <table class="table table-zebra w-full">
      <thead>
        <tr>
          @if (enableSelection()) {
          <th class="w-12">
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="isPageFullySelected()"
              (change)="togglePageChecked($any($event.target).checked)"
            />
          </th>
          } @for (col of colDefsWithEdit; track col.field) { @if (col.field) {
          <th (click)="headerClick(col)" class="cursor-pointer select-none">
            {{ col.headerName || col.field }}
            <span class="ml-1 text-xs opacity-70">{{ sortIndicator(col) }}</span>
          </th>
          } }
        </tr>
      </thead>
      <tbody>
        <!-- top spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding:0">
            <div [style.height.px]="topPadHeight()"></div>
          </td>
        </tr>
        @for (row of visibleRows(); track toId(row)) {
        <tr (mouseover)="onCellMouseOver(row)">
          @if (enableSelection()) {
          <td>
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="isRowChecked(toId(row))"
              (change)="toggleRowChecked(toId(row), $any($event.target).checked)"
            />
          </td>
          } @for (col of colDefsWithEdit; track col.field) { @if (col.field) {
          <td (dblclick)="handleCellDblClick(row, col)">
            @if (hasCellRenderer(col)) {
            <span [innerHTML]="callCellRenderer(row, col)"></span>
            } @else if (col.valueFormatter) {
            {{ callValueFormatter(row, col) }}
            } @else {
            {{ getCellValue(row, col) }}
            }
          </td>
          } }
        </tr>
        }
        <!-- bottom spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding:0">
            <div [style.height.px]="bottomPadHeight()"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="flex items-center justify-between mt-2">
    <div class="text-sm">Page {{ pageIndex() + 1 }} of {{ totalPages() }} ({{ totalCountAll }} rows)</div>
    <div class="join">
      <button class="btn btn-sm join-item" [disabled]="!canPrev()" (click)="prevPage()">Prev</button>
      <button class="btn btn-sm join-item" [disabled]="!canNext()" (click)="nextPage()">Next</button>
    </div>
  </div>
  @if (isLoading()) {
  <pc-icon name="loading" class="absolute inset-0 grid place-items-center animate-pulse" [size]="24"></pc-icon>
  }
</div>

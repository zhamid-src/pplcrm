<div class="flex h-full w-full flex-col">
  @if (showToolbar()) {
  <ul class="menu menu-horizontal flex flex-row pt-0">
    <pc-grid-action [enabled]="!!addRoute()" [tip]="'Add'" [icon]="plusIcon()" (action)="add()" />
    <pc-grid-action [enabled]="!disableRefresh()" [tip]="'Refresh the grid'" icon="arrow-path" (action)="refresh()" />
    <pc-grid-action [enabled]="!!undoMgr.canUndo()" [tip]="'Undo'" icon="arrow-uturn-left" (action)="undoMgr.undo()" />
    <pc-grid-action [enabled]="!!undoMgr.canRedo()" [tip]="'Redo'" icon="arrow-uturn-right" (action)="undoMgr.redo()" />
    <pc-grid-action
      [enabled]="!disableDelete() && hasSelection()"
      [tip]="'Deleted selected row(s)'"
      icon="trash"
      (action)="confirmDelete()"
    />
    <pc-grid-action [enabled]="canMerge()" [tip]="'Merge'" icon="merge" (action)="merge()"></pc-grid-action>
    <pc-grid-action
      [enabled]="!disableImport()"
      [tip]="'Import data from CSV'"
      icon="arrow-up-tray"
      (action)="doImportCSV()"
    />

    <pc-grid-action
      [enabled]="!disableExport()"
      [tip]="'Download as CSV'"
      icon="arrow-down-tray"
      (action)="confirmExport()"
    />
    <pc-grid-action icon="funnel" tip="Filter the grid" [active]="showFilters()" (action)="filter()" />
    <li class="dropdown dropdown-end">
      <label tabindex="0" class="btn btn-ghost btn-sm" title="Select columns">
        <pc-icon name="view-column"></pc-icon>
      </label>
      <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-64 p-2 shadow">
        <li class="px-2 py-1 flex gap-2">
          <button class="btn btn-ghost btn-xs" (click)="showAllCols()">Show all</button>
          <button class="btn btn-ghost btn-xs" (click)="hideAllCols()">Hide all</button>
          <button class="btn btn-ghost btn-xs" (click)="resetAllWidths()">Reset widths</button>
        </li>
        @for (col of colDefsWithEdit; track col.field) { @if (col.field) {
        <li>
          <label class="label cursor-pointer justify-start gap-2">
            <input
              type="checkbox"
              class="checkbox checkbox-xs"
              [checked]="isColVisible(col)"
              (change)="toggleCol(col.field!, $any($event.target).checked)"
            />
            <span class="label-text">{{ col.headerName || col.field }}</span>
          </label>
        </li>
        } }
      </ul>
    </li>
    <pc-grid-action
      icon="archive-box"
      tip="See archived tasks"
      [hidden]="!showArchiveIcon()"
      [active]="archiveMode()"
      (action)="toggleArchiveMode()"
    />
    <li class="grow">
      <a class="hover:text-primary ml-auto">
        <pc-icon name="information-circle"></pc-icon>
      </a>
    </li>
  </ul>
  } @if (isLoading()) {
  <progress class="progress h-1"></progress>
  } @if (isPageFullySelected() && displayedCount() < totalCountAll) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ displayedCount() }} rows on this page are selected.</span>
    <a class="link hover:no-underline" (click)="selectAllMatching()">Select all {{ totalCountAll }} rows</a>
  </div>
  } @if (allSelected()) {
  <div class="alert alert-success flex items-center gap-2 py-2 text-sm">
    <span>All {{ allSelectedCount || totalCountAll }} rows are selected.</span>
    <a class="link hover:no-underline" (click)="clearAllSelection()">Clear selection</a>
  </div>
  }
  <div #scroller class="flex-1 overflow-auto border border-base-300 rounded" (scroll)="onScroll($event)">
    <table #gridTable class="table table-zebra table-fixed w-full">
      <thead class="sticky top-0 bg-base-100 z-10">
        @let groups = headerGroups(); @for (grp of groups; track grp.id; let i = $index) {
        <tr>
          @if (enableSelection() && i === 0) {
          <th
            class="selection-col sticky left-0 z-10 bg-base-100 relative overflow-hidden"
            [attr.rowspan]="groups.length"
            [style.width.px]="selectionStickyWidth()"
          >
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="!allSelected() && tableAllPageSelected()"
              [indeterminate]="!allSelected() && tableSomePageSelected()"
              (change)="onHeaderCheckbox($any($event.target).checked)"
            />
            <!-- Always-visible visual divider -->
            <span class="pointer-events-none absolute top-0 right-0 h-full w-px bg-base-300/80 z-[15]"></span>
            <!-- Interactive resizer handle -->
            <span
              class="absolute top-0 right-0 h-full w-2 cursor-col-resize select-none z-[20] hover:bg-base-300/50"
              (mousedown)="onSelectionResizeMouseDown($event)"
              (touchstart)="onSelectionResizeTouchStart($event)"
              (dragstart)="onSelectionResizeDragStart($event)"
              draggable="false"
            ></span>
          </th>
          } @for (h of grp.headers; track h.id) { @if (h?.isPlaceholder) {
          <th [attr.colspan]="h.colSpan"></th>
          } @else {
          <th
            (click)="toggleHeaderSort(h, $event)"
            class="cursor-pointer select-none relative overflow-visible min-w-0 pr-0"
            draggable="true"
            (dragstart)="onHeaderDragStart(h, $event)"
            (dragover)="onHeaderDragOver(h, $event)"
            (drop)="onHeaderDrop(h, $event)"
            role="columnheader"
            [attr.aria-sort]="ariaSortHeader(h)"
            [attr.colspan]="h.colSpan"
            [class.sticky]="pinState(h) !== false"
            [style.left.px]="pinState(h) === 'left' ? leftOffsetPx(h.column.id) : null"
            [style.right.px]="pinState(h) === 'right' ? rightOffsetPx(h.column.id) : null"
            [style.zIndex]="pinState(h) !== false ? 20 : 40"
            [style.width.px]="getColWidth(h.column.id) || null"
            [attr.data-col-id]="h.column.id"
          >
            <div class="flex items-center gap-2 pr-0">
              <span class="flex-grow">{{ h.column?.columnDef?.header || h.column?.id }}</span>
              <pc-icon [name]="sortIndicatorForHeader(h)" [size]="4"></pc-icon>
              <!-- Dropdown moved to absolute container to avoid overlap with resizer -->
              <div
                tabindex="0"
                class="ml-auto mr-0 dropdown dropdown-end relative z-[100]"
                (click)="$event.stopPropagation()"
              >
                <label
                  tabindex="0"
                  class="btn btn-ghost btn-xs pointer-events-auto"
                  title="Column options"
                  (click)="$event.stopPropagation()"
                >
                  <pc-icon name="ellipsis-vertical"></pc-icon>
                </label>
                <ul
                  tabindex="0"
                  class="dropdown-content menu bg-base-100 rounded-box font-light z-[100] w-60 p-2 mt-1 shadow right-0"
                >
                  @let col = getColDefById(h.column.id);
                  <!-- Filter submenu as nested dropdown -->
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Filter</span><span class="pl-2">▸</span></label
                    >
                    <ul
                      tabindex="0"
                      class="dropdown-content menu bg-base-100 rounded-box z-[110] w-64 p-2 shadow transform -translate-x-2"
                    >
                      @if (col && getFilterOptionsForCol(col)?.length) { @for (opt of getFilterOptionsForCol(col!)!;
                      track opt) {
                      <li>
                        <label
                          class="label cursor-pointer justify-start gap-2 px-2 py-1"
                          (click)="$event.stopPropagation()"
                        >
                          <input
                            type="checkbox"
                            class="checkbox checkbox-xs"
                            [checked]="isOptionChecked(h.column.id, opt)"
                            (change)="onToggleFilterOption(h.column.id, opt, $any($event.target).checked)"
                          />
                          <span class="label-text">{{ opt }}</span>
                        </label>
                      </li>
                      }
                      <li class="px-2 pt-1"><a (click)="clearHeaderFilter(h.column.id)">Clear</a></li>
                      } @else {
                      <li class="px-2 py-1">
                        <input
                          class="input input-bordered input-xs w-full"
                          type="text"
                          placeholder="Filter value"
                          [value]="getFilterValue(h.column.id)"
                          (input)="onHeaderFilterInput(h.column.id, $any($event.target).value)"
                          (click)="$event.stopPropagation()"
                        />
                      </li>
                      <li class="px-2 pt-1"><a (click)="clearHeaderFilter(h.column.id)">Clear</a></li>
                      }
                    </ul>
                  </li>
                  <!-- Sort submenu as nested dropdown -->
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Sort</span><span class="pl-2">▸</span></label
                    >
                    <ul
                      tabindex="0"
                      class="dropdown-content menu bg-base-100 rounded-box z-[110] w-48 p-2 shadow transform -translate-x-2"
                    >
                      <li><a (click)="sortAsc(h)">Sort asc</a></li>
                      <li><a (click)="sortDesc(h)">Sort desc</a></li>
                      <li><a (click)="clearSort(h)">Clear sort</a></li>
                    </ul>
                  </li>
                  <!-- Stickiness submenu as nested dropdown -->
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Stickiness</span><span class="pl-2">▸</span></label
                    >
                    <ul
                      tabindex="0"
                      class="dropdown-content menu bg-base-100 rounded-box z-[110] w-48 p-2 shadow transform -translate-x-2"
                    >
                      <li><a (click)="pinLeft(h)">Pin left</a></li>
                      <li><a (click)="pinRight(h)">Pin right</a></li>
                      <li><a (click)="unpin(h)">Unpin</a></li>
                    </ul>
                  </li>
                  <!-- Size submenu as nested dropdown -->
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Size</span><span class="pl-2">▸</span></label
                    >
                    <ul
                      tabindex="0"
                      class="dropdown-content menu bg-base-100 rounded-box z-[110] w-56 p-2 shadow transform -translate-x-2"
                    >
                      <li><a (click)="autoSizeColumn(h)">Auto-size</a></li>
                      <li><a (click)="resetColWidth(h)">Reset width</a></li>
                    </ul>
                  </li>
                  <!-- Column submenu as nested dropdown -->
                  <li class="dropdown dropdown-right">
                    <label tabindex="0" class="flex w-full items-center justify-between"
                      ><span>Column</span><span class="pl-2">▸</span></label
                    >
                    <ul
                      tabindex="0"
                      class="dropdown-content menu bg-base-100 rounded-box z-[110] w-64 p-2 shadow transform -translate-x-2"
                    >
                      <li><a (click)="hideColumn(h)">Hide</a></li>
                      <li class="dropdown dropdown-right">
                        <label tabindex="0" class="flex w-full items-center justify-between"
                          ><span>Columns</span><span class="pl-2">▸</span></label
                        >
                        <ul
                          tabindex="0"
                          class="dropdown-content menu bg-base-100 rounded-box z-[120] w-64 p-2 shadow transform -translate-x-2"
                        >
                          @for (cid of hiddenColumns(); track cid) {
                          <li><a (click)="showColumnById(cid)">Show {{ columnLabelFor(cid) }}</a></li>
                          } @if (!hiddenColumns().length) {
                          <li class="opacity-60 px-2 py-1">None hidden</li>
                          }
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            @if (i === groups.length - 1) {
            <!-- Always-visible visual divider -->
            <span class="pointer-events-none absolute top-0 right-0 h-full w-px bg-base-300/80 z-[30]"></span>
            <!-- Interactive resizer handle (kept narrow) -->
            <span
              class="absolute top-0 right-0 h-full w-1 cursor-col-resize select-none z-40 hover:bg-base-300/50"
              (mousedown)="onHeaderResizeMouseDown(h, $event)"
              (touchstart)="onHeaderResizeTouchStart(h, $event)"
              (dblclick)="onHeaderResizeDblClick(h, $event)"
              (dragstart)="onHeaderResizeDragStart($event)"
              draggable="false"
            ></span>
            }
          </th>
          } }
        </tr>
        } @if (showFilters()) {
        <tr>
          @if (enableSelection()) {
          <th class="selection-col sticky left-0 z-30 bg-base-100" [style.width.px]="selectionStickyWidth()"></th>
          } @for (h of leafHeaders(); track h.id) { @if (h && h.column?.getIsVisible?.()) { @let col =
          getColDefById(h.column.id);
          <th class="border-r border-base-300">
            @if (col && getFilterOptionsForCol(col)?.length) {
            <div class="dropdown dropdown-bottom w-full">
              <label tabindex="0" class="btn btn-ghost btn-xs w-full justify-between">
                <span>{{ inlineFilterLabel(col!.field!) }}</span>
                <span>▾</span>
              </label>
              <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[100] w-60 p-2 shadow">
                @for (opt of getFilterOptionsForCol(col!)!; track opt) {
                <li>
                  <label class="label cursor-pointer justify-start gap-2 px-2 py-1" (click)="$event.stopPropagation()">
                    <input
                      type="checkbox"
                      class="checkbox checkbox-xs"
                      [checked]="isOptionChecked(col!.field!, opt)"
                      (change)="onToggleFilterOption(col!.field!, opt, $any($event.target).checked)"
                    />
                    <span class="label-text">{{ opt }}</span>
                  </label>
                </li>
                }
                <li class="px-2 pt-1"><a (click)="clearHeaderFilter(col!.field!)">Clear</a></li>
              </ul>
            </div>
            } @else {
            <input
              type="text"
              class="input input-bordered input-xs w-full"
              placeholder="Filter..."
              [value]="$any(filterValues())[col!.field!] || ''"
              (input)="onFilterInput(col!.field!, $any($event.target).value)"
            />
            }
          </th>
          } }
        </tr>
        }
      </thead>
      <tbody>
        <!-- top spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding: 0">
            <div [style.height.px]="topPadHeight()"></div>
          </td>
        </tr>
        @for (r of visibleTableRows(); track r.id) {
        <tr (mouseover)="onCellMouseOver(r.original)" [attr.data-row-id]="toId(r.original)">
          @if (enableSelection()) {
          <td class="sticky left-0 z-20 bg-base-100" [style.width.px]="selectionStickyWidth()">
            <input
              type="checkbox"
              class="checkbox checkbox-sm"
              [checked]="allSelected() ? allSelectedIdSet.has(toId(r.original)) : r.getIsSelected()"
              (change)="onRowCheckboxChange(r, $any($event.target).checked)"
            />
          </td>
          } @for (cell of r.getVisibleCells(); track cell.id) { @let col = getColDefById(cell.column.id); @if (col &&
          isColVisible(col)) {
          <td
            (dblclick)="handleCellDblClick(r.original, col)"
            tabindex="0"
            (keydown)="onCellKeydown($event)"
            [class.sticky]="pinState(cell) !== false"
            [style.left.px]="pinState(cell) === 'left' ? leftOffsetPx(cell.column.id) : null"
            [style.right.px]="pinState(cell) === 'right' ? rightOffsetPx(cell.column.id) : null"
            [style.background]="pinState(cell) !== false ? 'var(--fallback-b1,oklch(var(--b1)))' : null"
            [style.zIndex]="pinState(cell) !== false ? 10 : null"
            [style.width.px]="getColWidth(cell.column.id) || null"
            class="overflow-hidden min-w-0"
            [attr.data-col-id]="cell.column.id"
          >
            @let ec = editingCell(); @if (ec && ec.id === toId(r.original) && ec.field === col.field) { @let opts =
            getFilterOptionsForCol(col); @if (opts?.length) {
            <select
              class="select select-bordered select-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              (blur)="commitEdit(r.original, col)"
              (keydown.enter)="commitEdit(r.original, col)"
              (keydown.esc)="cancelEdit()"
              autofocus
            >
              @for (o of opts; track o) {
              <option [value]="o">{{ o }}</option>
              }
            </select>
            } @else {
            <input
              [type]="inputTypeFor(col)"
              class="input input-bordered input-xs w-full"
              [ngModel]="editingValue()"
              (ngModelChange)="editingValue.set($event)"
              (blur)="commitEdit(r.original, col)"
              (keydown.enter)="commitEdit(r.original, col)"
              (keydown.esc)="cancelEdit()"
              autofocus
            />
            } } @else if (hasCellRenderer(col)) {
            <span [innerHTML]="callCellRenderer(r.original, col)"></span>
            } @else if (col.valueFormatter) { {{ callValueFormatter(r.original, col) }} } @else { {{
            getCellValue(r.original, col) }} }
          </td>
          } }
        </tr>
        }
        <!-- bottom spacer -->
        <tr>
          <td [attr.colspan]="(enableSelection() ? 1 : 0) + colDefsWithEdit.length" style="padding: 0">
            <div [style.height.px]="bottomPadHeight()"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="flex items-center justify-between mt-2">
    <div class="text-sm">Page {{ pageIndex() + 1 }} of {{ totalPages() }} ({{ totalCountAll }} rows)</div>
    <div class="join">
      <button class="btn btn-sm join-item" [disabled]="!canPrev()" (click)="prevPage()">Prev</button>
      <button class="btn btn-sm join-item" [disabled]="!canNext()" (click)="nextPage()">Next</button>
    </div>
  </div>
  @if (isLoading()) {
  <pc-icon name="loading" class="absolute inset-0 grid place-items-center animate-pulse" [size]="24"></pc-icon>
  }
</div>

<!-- Right-side Filter Panel -->
@if (showFilterPanel()) {
<div class="fixed inset-0 z-40">
  <div class="absolute inset-0 bg-black/30" (click)="closePanel()"></div>
  <aside class="absolute right-0 top-0 h-full w-[360px] max-w-[90vw] bg-base-100 shadow-xl p-4 overflow-auto">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Advanced Filters</h3>
      <button class="btn btn-ghost btn-sm" (click)="closePanel()">
        <pc-icon name="chevron-right"></pc-icon>
      </button>
    </div>
    <div class="text-sm opacity-70 mb-3">Combine column filters and operators.</div>
    <div class="space-y-3">
      @for (field of panelFields(); track field) {
      <div class="form-control">
        <label class="label py-0"><span class="label-text">{{ panelLabelFor(field) }}</span></label>
        <div class="flex gap-2">
          <select
            class="select select-bordered select-xs w-28"
            (change)="onPanelOpChange(field, $any($event.target).value)"
            [value]="$any(panelFilters())[field]?.op || 'contains'"
          >
            <option value="contains">contains</option>
            <option value="equals">equals</option>
          </select>
          @if (panelOptionsFor(field)?.length) {
          <select
            class="select select-bordered select-xs flex-1"
            (change)="onPanelValueChange(field, $any($event.target).value)"
            [value]="$any(panelFilters())[field]?.value || ''"
          >
            <option value="">Any</option>
            @for (opt of panelOptionsFor(field)!; track opt) {
            <option [value]="opt">{{ opt }}</option>
            }
          </select>
          } @else {
          <input
            class="input input-bordered input-xs flex-1"
            type="text"
            placeholder="Value"
            (input)="onPanelValueChange(field, $any($event.target).value)"
            [value]="$any(panelFilters())[field]?.value || ''"
          />
          }
        </div>
      </div>
      }
    </div>
    <div class="divider my-3"></div>
    <div class="flex gap-2">
      <button class="btn btn-primary btn-sm" (click)="applyPanelFilters()">Apply</button>
      <button class="btn btn-ghost btn-sm" (click)="clearPanelFilters()">Clear</button>
    </div>
  </aside>
</div>
}

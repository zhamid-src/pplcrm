<header class="border-b border-gray-200 p-4">
  <div class="flex items-center gap-2 min-w-0 border-b-2 border-gray-100 pb-2">
    <h1 class="text-2xl font-semibold truncate">{{ email()!.subject }}</h1>
  </div>
  <div class="flex items-start gap-3 mt-2">
    <pc-email-assign [email]="email()"></pc-email-assign>
    <div class="min-w-0 flex-1"></div>

    <div class="flex items-center gap-1 text-sm text-base-content/70">
      <span class="whitespace-nowrap pr-2">
        {{ (getDateSent() || email()!.updated_at) | date:'EEE, MMM d, h:mm a' }}
      </span>

      <!-- Reply -->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        data-tip="reply"
        aria-label="Reply"
        (click)="handleReply()"
      >
        <pc-icon name="reply" [size]="4"></pc-icon>
      </button>

      <!-- Reply All -->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        data-tip="Reply All"
        aria-label="Reply All"
        (click)="handleReplyAll()"
      >
        <pc-icon name="reply-all" [size]="4"></pc-icon>
      </button>

      <!-- Forward-->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        data-tip="Forward"
        aria-label="Forward"
        (click)="handleForward()"
      >
        <pc-icon name="reply" [size]="4" class="scale-x-[-1]"></pc-icon>
      </button>

      <!-- Star/Favorite -->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        data-tip="Toggle favourite"
        aria-label="Star"
        data-testid="favorite-button"
        (click)="toggleFavourite()"
      >
        <pc-icon [size]="4" [name]="getFavouriteIcon()" [class.text-primary]="isFavourite()"></pc-icon>
      </button>

      <!-- Close/Mark as Done -->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        [attr.data-tip]="markAsDoneText()"
        aria-label="Mark as Done"
        (click)="toggleClosed()"
      >
        <pc-icon [size]="4" name="check-circle" [class.text-primary]="isClosed()"></pc-icon>
      </button>

      <!-- Delete -->
      <button
        class="tooltip btn btn-ghost btn-circle btn-sm"
        data-tip="delete"
        aria-label="Delete"
        (click)="handleDelete()"
      >
        <pc-icon [size]="4" name="trash" class="text-error"></pc-icon>
      </button>

      <!-- More Actions Dropdown -->
      <div class="dropdown dropdown-end">
        <button tabindex="0" class="btn btn-ghost btn-circle btn-sm" aria-label="More">
          <svg viewBox="0 0 24 24" class="h-5 w-5">
            <path
              fill="currentColor"
              d="M12 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"
            />
          </svg>
        </button>
        <ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-48 p-2 shadow">
          <li>
            <a (click)="handleForward()"><pc-icon [size]="4" name="reply" class="scale-x-[-1]"></pc-icon> Forward</a>
          </li>
          <li>
            <a (click)="handleMarkAsUnread()"><pc-icon name="envelope" [size]="4"></pc-icon> Mark as unread</a>
          </li>
          <li class="divider"></li>
          <li>
            <a (click)="handleReply()"><pc-icon [size]="4" name="reply"></pc-icon> Reply</a>
          </li>
          <li>
            <a (click)="handleReplyAll()"><pc-icon [size]="4" name="reply-all"></pc-icon> Reply All</a>
          </li>
          <li>
            <a (click)="toggleFavourite()"
              ><pc-icon [name]="getFavouriteIcon()" [size]="4"></pc-icon> {{ isFavourite() ? 'Unstar' : 'Star' }}</a
            >
          </li>
          <li>
            <a (click)="toggleClosed()"
              ><pc-icon [class.text-primary]="isClosed()" name="check-circle" [size]="4"></pc-icon> {{ isClosed() ?
              'Mark as Open' : 'Mark as Done' }}</a
            >
          </li>
          <li>
            <a (click)="handleDelete()"><pc-icon name="trash" [size]="4" class="text-error"></pc-icon> Delete</a>
          </li>
          <li class="divider"></li>
          <li>
            <a><pc-icon [size]="4" name="print"></pc-icon>Print</a>
          </li>
          <li>
            <a><pc-icon [size]="4" name="arrow-top-right-on-square"></pc-icon>Open in new</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="mt-3 flex items-center gap-3">
    <div class="avatar">
      <div class="w-10 rounded-full bg-base-200">
        <span class="flex h-full w-full items-center justify-center font-medium">
          {{ (email()!.from_name || email()!.from_email)![0] | uppercase }}
        </span>
      </div>
    </div>

    <div class="min-w-0 flex-1">
      <div class="flex items-baseline gap-2 min-w-0">
        <span class="font-semibold truncate"> {{ email()!.from_name || email()!.from_email }} </span>
        <span class="text-xs text-base-content/60 truncate"> &lt;{{ email()!.from_email }}&gt; </span>
      </div>

      <div class="text-xs text-base-content/60">
        to
        <div class="dropdown inline-block">
          <button tabindex="0" class="btn btn-link btn-sm font-light no-underline align-baseline p-0 h-auto min-h-0">
            @if (getToRecipients().length > 0) { {{ getToRecipients()[0].name || getToRecipients()[0].email }} @if
            (getToRecipients().length > 1) {
            <span class="text-base-content/40">+{{ getToRecipients().length - 1 }} more</span>
            } } @else { {{ email()!.to_email }} }
            <svg class="ml-1 h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08z"
              />
            </svg>
          </button>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content z-[1] mt-1 w-96 rounded-box bg-base-100 p-2 shadow max-h-96 overflow-y-auto"
          >
            <!-- Recipients Section -->
            <li class="menu-title text-xs">Recipients</li>

            @if (getToRecipients().length > 0) {
            <li class="menu-title text-xs mt-2">To:</li>
            @for (recipient of getToRecipients(); track recipient.email) {
            <li>
              <a class="truncate text-xs">{{ recipient.name || recipient.email }} &lt;{{ recipient.email }}&gt;</a>
            </li>
            } } @if (getCcRecipients().length > 0) {
            <li class="menu-title text-xs mt-2">CC:</li>
            @for (recipient of getCcRecipients(); track recipient.email) {
            <li>
              <a class="truncate text-xs">{{ recipient.name || recipient.email }} &lt;{{ recipient.email }}&gt;</a>
            </li>
            } } @if (getBccRecipients().length > 0) {
            <li class="menu-title text-xs mt-2">BCC:</li>
            @for (recipient of getBccRecipients(); track recipient.email) {
            <li>
              <a class="truncate text-xs">{{ recipient.name || recipient.email }} &lt;{{ recipient.email }}&gt;</a>
            </li>
            } } @if (getToRecipients().length === 0 && getCcRecipients().length === 0 && getBccRecipients().length ===
            0) {
            <li><a class="truncate text-xs">{{ email()!.to_email }}</a></li>
            }

            <!-- Email Details Section -->
            <li class="divider mt-3"></li>
            <li class="menu-title text-xs">Email Details</li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Subject:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().subject }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Date:</span>
                  <span class="text-xs ml-2">{{ getHeaderInfo().date | date:'MMM d, y, h:mm a' }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">From:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().from }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Reply-To:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().replyTo }}</span>
                </div>
              </div>
            </li>

            <!-- Technical Details Section -->
            <li class="divider mt-2"></li>
            <li class="menu-title text-xs">Technical Details</li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Message-ID:</span>
                  <span class="text-xs truncate ml-2 font-mono">{{ getHeaderInfo().messageId }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Mailed-By:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().mailedBy }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Security:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().security }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Signed-By:</span>
                  <span class="text-xs truncate ml-2">{{ getHeaderInfo().signedBy }}</span>
                </div>
              </div>
            </li>

            <li>
              <div class="flex flex-col gap-1 py-1">
                <div class="flex justify-between">
                  <span class="text-xs font-medium">Return-Path:</span>
                  <span class="text-xs truncate ml-2 font-mono">{{ getHeaderInfo().returnPath }}</span>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-1">
      <pc-swap
        class="hover:text-primary tooltip tooltip-left"
        [attr.data-tip]="'Expand email body'"
        [checked]="isExpanded()"
        swapOffIcon="arrows-pointing-out"
        swapOnIcon="arrows-pointing-in"
        [size]="4"
        (clickEvent)="toggleExpand()"
      ></pc-swap>
    </div>
  </div>
</header>

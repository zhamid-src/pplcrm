<!-- Template for person detail view -->
<div class="flex min-h-full flex-col bg-base-100">
  <progress class="progress w-full" [class.hidden]="!isLoading()"></progress>
  <form [formGroup]="form" class="mx-5 mt-10 sm:mx-10">
    <fieldset [disabled]="isLoading()">
      <div class="flex flex-col gap-4">
        @if (!person()?.id) {
        <label class="label text-base font-light">All fields are optional, but try to add as much as possible </label>
        } @else {
        <div>
          <div class="divider mb-1">{{ getFormName() }}</div>
          <div class="font-light text-xs text-center text-gray-500">
            <span>
              (Added by {{ getUserName(person()?.createdby_id) }} on {{ getCreatedAt() | date:'M/d/yyyy' }}. Last
              updated on {{ getUpdatedAt() | date:'M/d/yyyy' }} by {{ getUserName(person()?.updatedby_id) }}.)
            </span>
          </div>
        </div>

        <div class="text-center">
          <div class="stats stats-vertical md:stats-horizontal shadow mr-2 mb-10">
            <div class="stat">
              <div class="stat-title">Emails sent</div>
              <div class="stat-value">0</div>
              <div class="stat-desc">Jan 1st - Feb 1st</div>
            </div>

            <div class="stat">
              <div class="stat-title">Emails read</div>
              <div class="stat-value">0</div>
              <div class="stat-desc">↗︎ 400 (22%)</div>
            </div>

            <div class="stat">
              <div class="stat-title">Lists</div>
              <div class="stat-value">0</div>
            </div>
          </div>
          <div class="stats stats-vertical md:stats-horizontal shadow mb-10">
            <div class="stat">
              <div class="stat-title">Donations</div>
              <div class="stat-value">$0</div>
              <div class="stat-desc">Jan 1st - Feb 1st</div>
            </div>

            <div class="stat">
              <div class="stat-title">Volunteered</div>
              <div class="stat-value">0</div>
              <div class="stat-desc">↗︎ 400 (22%)</div>
            </div>

            <div class="stat">
              <div class="stat-title">Tasks</div>
              <div class="stat-value">0</div>
              <div class="stat-desc">↘︎ 90 (14%)</div>
            </div>
          </div>
        </div>
        }
        <div class="flex flex-col md:flex-row gap-2">
          <input type="text" class="input basis-1/3" placeholder="First Name" formControlName="first_name" />
          <input type="text" class="input basis-1/3" placeholder="Middle Name(s)" formControlName="middle_names" />
          <input type="text" class="input basis-1/3" placeholder="Last Name" formControlName="last_name" />
        </div>
        <div class="flex flex-col md:flex-row gap-2">
          <label class="input validator basis-1/2">
            <input type="email" placeholder="Email" formControlName="email" />
          </label>
          <label class="input validator basis-1/2">
            <input type="email" placeholder="Email 2" formControlName="email2" />
          </label>
        </div>
        <div class="flex flex-col md:flex-row gap-2">
          <label class="input validator basis-1/2">
            <input type="tel" placeholder="Mobile Phone" formControlName="mobile" />
          </label>
          <label class="input validator basis-1/2">
            <input type="tel" placeholder="Home Phone" formControlName="home_phone" />
          </label>
        </div>

        @if (person()?.household_id) {
        <div class="text-sm pl-1 flex gap-2">
          Address: <span class="font-light">{{ addressString() }}</span>
          <pc-icon
            name="chevron-down"
            [size]="4"
            class="hover:text-primary cursor-pointer"
            (click)="openAssignDrawer()"
          ></pc-icon>
          <pc-icon
            (click)="navigateToHousehold()"
            class="link font-light hover:text-primary"
            name="arrow-top-right-on-square"
            [size]="4"
          ></pc-icon>

          <pc-icon (click)="removeAddress()" class="link font-light hover:text-error" name="trash" [size]="4"></pc-icon>
        </div>
        } @else {
        <!-- TODO: select address with autocomplete (or add a link to a new address )-->

        }
        <pc-tags
          [tags]="tags()"
          [enableAutoComplete]="true"
          (tagAdded)="tagAdded($event)"
          (tagRemoved)="tagRemoved($event)"
        ></pc-tags>

        <textarea class="textarea textarea-bordered h-24 w-full" placeholder="Notes" formControlName="notes"></textarea>

        @if (householdId()) {
        <div class="divider mb-1">OTHERS IN HOUSEHOLD</div>
        <pc-people-in-household [householdId]="householdId()!" [excludePersonId]="getId()"></pc-people-in-household>
        }

        <pc-add-btn-row
          [isLoading]="isLoading()"
          (btn1Clicked)="save()"
          [buttonsToShow]="person()?.id ? 'two' : 'three'"
        ></pc-add-btn-row>
      </div>
    </fieldset>
  </form>
  <!-- Right-side drawer: Assign to a different household -->
  @if (assignDrawerOpen()) {
  <div class="fixed inset-0 z-30">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/30" (click)="closeAssignDrawer()"></div>
    <!-- Panel -->
    <div
      class="absolute right-0 top-0 h-full w-full sm:w-[420px] max-w-[90vw] bg-base-100 shadow-xl border-l border-base-300 flex flex-col"
    >
      <div class="flex items-center justify-between p-4 border-b border-base-300">
        <div class="font-semibold">Assign to a different household</div>
        <button class="btn btn-ghost btn-sm" (click)="closeAssignDrawer()">
          <pc-icon name="x-mark" [size]="4"></pc-icon>
        </button>
      </div>
      <div class="p-4 flex flex-col gap-3">
        <input
          type="text"
          class="input w-full"
          placeholder="Search address, city, zip, tag..."
          [value]="householdSearch()"
          (input)="onHouseholdSearch($event)"
        />
        <div class="text-xs text-base-content/60" [class.hidden]="!householdsLoading()">Searching households…</div>
        <div
          class="divide-y divide-base-300 rounded-box border border-base-300 max-h-[60vh] overflow-y-auto"
          [class.hidden]="householdsLoading() && householdResults().length === 0"
        >
          @for (h of householdResults(); track h.id) {
          <div class="p-3 hover:bg-base-200 flex items-start justify-between gap-2">
            <div class="text-sm">
              <div class="font-medium">{{ formatHouseholdRow(h) }}</div>
              <div class="text-xs text-base-content/60">People: {{ h.persons_count || 0 }}</div>
            </div>
            <button class="btn btn-primary btn-sm" (click)="assignToHousehold(h.id)">Assign</button>
          </div>
          } @if (!householdsLoading() && householdResults().length === 0) {
          <div class="p-4 text-sm text-center text-base-content/60">No households found</div>
          }
        </div>
      </div>
    </div>
  </div>
  }
</div>

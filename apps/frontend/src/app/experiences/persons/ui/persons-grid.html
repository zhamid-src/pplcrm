<!-- Template for persons grid -->
<pc-datagrid
  [colDefs]="col"
  [disableDelete]="false"
  addRoute="add"
  [disableView]="false"
  [limitToTags]="limitTags"
  [disableImport]="false"
  (importCSV)="openImportDialog()"
  plusIcon="user-plus"
></pc-datagrid>

<dialog id="confirmAddressEdit" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">Address Edit</h3>
    <p class="py-2 font-light">
      Addresses can only be edited in the Households Component. Would you like me to take you there?
    </p>

    <form method="dialog" class="modal-backdrop float-right flex flex-row gap-2">
      <button class="btn btn-primary" (click)="routeToHouseholds()">
        <pc-icon name="arrow-right-start-on-rectangle" />
        Yes
      </button>
      <button class="btn">
        <pc-icon name="x-circle" />
        Cancel
      </button>
    </form>
  </div>
</dialog>

<!-- Import Summary Modal -->
<dialog id="importSummary" class="modal" [open]="importSummaryOpen()" (close)="importSummaryOpen.set(false)">
  <div class="modal-box">
    @if (!importSummary().failed) {
    <h3 class="text-lg font-bold mb-2">Import Summary</h3>
    <ul class="menu bg-base-100 rounded-box p-2">
      <li class="opacity-90"><span>Inserted: {{ importSummary().inserted }}</span></li>
      <li class="opacity-90"><span>Errors: {{ importSummary().errors }}</span></li>
      <li class="opacity-90"><span>Skipped (empty mapping): {{ importSummary().skipped }}</span></li>
      @if (importSummary().tag) {
      <li class="opacity-90"><span>Applied tag: {{ importSummary().tag }}</span></li>
      }
      @if (importSummary().message) {
      <li class="opacity-90 whitespace-pre-wrap text-xs"><span>{{ importSummary().message }}</span></li>
      }
    </ul>
    } @else {
    <h3 class="text-lg font-bold mb-2">Import Failed</h3>
    <p class="py-2 font-light">{{ importSummary().message }}</p>
    <ul class="menu bg-base-100 rounded-box p-2">
      <li class="opacity-90"><span>Skipped (empty mapping): {{ importSummary().skipped }}</span></li>
    </ul>
    }
    <div class="modal-action">
      <form method="dialog">
        <button class="btn" (click)="importSummaryOpen.set(false)">OK</button>
      </form>
    </div>
  </div>
</dialog>

<!-- Import Persons Modal -->
<dialog id="importPersons" class="modal" [open]="importDialogOpen()" (close)="importDialogOpen.set(false)">
  <div class="modal-box max-w-5xl">
    <h3 class="text-lg font-bold mb-3">Import People from CSV</h3>
    <div class="grid gap-4">
      <!-- Step 1: File input -->
      <div class="grid gap-2">
        <label class="font-semibold">1) Choose CSV file</label>
        <input type="file" accept=".csv,text/csv" (change)="onFileSelected($event)" class="file-input file-input-bordered" />
        <p class="text-xs opacity-70">First row should contain headers. UTF-8 CSV supported.</p>
      </div>

      @if (importLoading()) {
      <div class="grid gap-2">
        <progress class="progress w-full"></progress>
        <span class="text-xs opacity-70" aria-live="polite"
          >Reading and parsing the file will take a few moments ...</span
        >
      </div>
      }

      <!-- Step 2: Mapping UI -->
      @if (csvHeaders.length) {
      <div class="grid gap-2">
        <label class="font-semibold">2) Map CSV columns</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          @for (i of csvHeaders; track i; let idx = $index) {
            <div class="grid grid-cols-2 gap-2 items-center">
              <div class="truncate" title="{{ i }}">{{ i }}</div>
              <select class="select select-bordered select-sm" [(ngModel)]="mapping[idx]">
                <option value="">Skip</option>
                @for (f of mappableFields; track f) {
                <option [value]="f">{{ f }}</option>
                }
              </select>
            </div>
          }
        </div>
      </div>
      }

      <!-- Step 3: Tags -->
      <div class="grid gap-2">
        <label class="font-semibold">3) Add tags to all imported rows (optional)</label>
        <input class="input input-bordered" placeholder="Comma separated e.g. donor, volunteer" [(ngModel)]="tagsInput" />
      </div>

      <!-- Preview sample rows -->
      @if (csvRows.length) {
      <div class="grid gap-2">
        <label class="font-semibold">Preview (first 5 rows)</label>
        <div class="overflow-auto border rounded relative">
          @if (importLoading()) {
          <div class="absolute inset-0 bg-base-100/70 grid place-items-center z-10">
            <progress class="progress w-64"></progress>
          </div>
          }
          <table class="table table-zebra table-xs">
            <thead>
              <tr>
                @for (h of csvHeaders; track h) {
                <th>{{ h }}</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (r of getPreviewRows(); track r) {
              <tr>
                @for (h of csvHeaders; track h) {
                <td>{{ r[h] }}</td>
                }
              </tr>
              }
            </tbody>
          </table>
          <div class="flex items-center justify-end gap-2 p-2">
            <button class="btn btn-xs" [disabled]="!canPrevPage()" (click)="prevPreviewPage()">Prev</button>
            <span class="text-xs opacity-70">Page {{ previewPage + 1 }} of {{ previewTotalPages() }}</span>
            <button class="btn btn-xs" [disabled]="!canNextPage()" (click)="nextPreviewPage()">Next</button>
          </div>
        </div>
      </div>
      }

      <!-- Actions -->
      <div class="flex justify-end gap-2 mt-2">
        <form method="dialog">
          <button class="btn" (click)="importDialogOpen.set(false)">Cancel</button>
        </form>
        <button class="btn btn-primary" [disabled]="!csvRows.length" (click)="runImport()">
          <pc-icon name="cloud-arrow-up" />
          Import
        </button>
      </div>
    </div>
  </div>
</dialog>

<div class="flex min-h-full flex-col bg-base-100">
  <div class="mx-5 my-6 sm:mx-10 grid gap-4">
    <div class="grid gap-3 sm:grid-cols-2">
      <input
        class="input"
        placeholder="Task name"
        [value]="task()?.name || ''"
        (change)="update({ name: $any($event.target).value })"
      />
      <div class="grid grid-cols-3 gap-2">
        <select
          class="select select-bordered"
          [value]="task()?.status || ''"
          (change)="update({ status: $any($event.target).value })"
        >
          <option value="todo">Todo</option>
          <option value="in_progress">In Progress</option>
          <option value="blocked">Blocked</option>
          <option value="done">Done</option>
          <option value="canceled">Canceled</option>
        </select>
        <select
          class="select select-bordered"
          [value]="task()?.priority || ''"
          (change)="update({ priority: $any($event.target).value })"
        >
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="urgent">Urgent</option>
        </select>
        <input
          class="input"
          type="date"
          [value]="dateOnly(task()?.due_at)"
          (change)="update({ due_at: $any($event.target).value })"
        />
      </div>
    </div>

    <div class="grid gap-3 sm:grid-cols-2 items-start">
      <select
        class="select select-bordered"
        [ngModel]="assignedTo()"
        (ngModelChange)="onAssignedChange($event)"
      >
        <option value="">Unassigned</option>
        @for (u of users(); track u.id) {
        <option [value]="'' + u.id">{{ u.first_name }}</option>
        }
      </select>
      <div class="flex gap-2">
        <button class="btn btn-outline" (click)="assignToMe()">Assign to me</button>
        @if (!isArchived()) {
        <button class="btn btn-outline btn-error" (click)="archiveTask()">Archive</button>
        } @else {
        <button class="btn btn-outline" (click)="unarchiveTask()">Unarchive</button>
        }
      </div>
      <div class="text-sm text-base-content/60 flex items-center gap-3">
        <div>Created by: <span class="font-medium">{{ userName(task()?.createdby_id) }}</span></div>
        <div>On: {{ asDate(task()?.created_at) | date: 'y-MM-dd' }}</div>
      </div>
    </div>

    <div class="grid gap-2">
      <quill-editor
        [styles]="{ height: '220px' }"
        [ngModel]="task()?.details || ''"
        (ngModelChange)="update({ details: $event })"
      ></quill-editor>
    </div>

    <div class="grid gap-2">
      <div class="flex items-center gap-2 select-none">
        <div class="divider flex-1">Subtasks ({{ subtasks().length }})</div>
        <button class="btn btn-ghost btn-xs" (click)="showSubtasks.set(!showSubtasks())">
          @if (showSubtasks()) { Hide } @else { Show }
        </button>
      </div>
      @if (showSubtasks()) {
      <div class="grid gap-2">
        @for (s of subtasks(); track s.id) {
        <label class="flex items-center gap-2">
          <input
            type="checkbox"
            class="checkbox checkbox-sm"
            [checked]="s.status === 'done'"
            (change)="toggleSubtask(s, $any($event.target).checked)"
          />
          <span [class.line-through]="s.status === 'done'">{{ s.name }}</span>
        </label>
        }
      </div>
      <div class="flex gap-2">
        <input class="input grow" placeholder="Add a subtask" [(ngModel)]="subtaskName" />
        <button class="btn btn-primary" (click)="addSubtask()" [disabled]="!subtaskName || isLoading()">Add</button>
      </div>
      }
    </div>

    <div class="grid gap-2">
      <div class="flex items-center gap-2 select-none">
        <div class="divider flex-1">Comments ({{ comments().length }})</div>
        <button class="btn btn-ghost btn-xs" (click)="showComments.set(!showComments())">
          @if (showComments()) { Hide } @else { Show }
        </button>
      </div>
      @if (showComments()) {
      <div class="p-2 space-y-3">
        @for (c of comments(); track c.id) {
        <div
          class="chat group"
          [class.chat-start]="(c.author_id || c.createdby_id) === myUserId()"
          [class.chat-end]="(c.author_id || c.createdby_id) !== myUserId()"
        >
          <!-- avatar -->
          <div class="chat-image avatar">
            <div class="w-8 h-8 rounded-full bg-base-300 text-base-content !grid place-items-center leading-none">
              <span class="text-xs font-medium uppercase">
                {{ (userName(c.author_id || c.createdby_id) || '?') | slice: 0:1 }}
              </span>
            </div>
          </div>

          <!-- header -->
          <div class="chat-header flex items-center text-xs">
            <span class="font-medium">{{ userName(c.author_id || c.createdby_id) }}</span>

            @if (c.created_at) {
            <span class="text-gray-500 tooltip cursor-pointer" [attr.data-tip]="asDate(c.created_at) | date:'medium'">
              {{ asDate(c.created_at) | timeAgo:{ thresholdDays: 7, style: 'long' } }}
            </span>
            }
            <span class="flex-1"></span>
          </div>

          <!-- bubble -->
          <div class="chat-bubble" [innerHTML]="c.comment | mentionify:users() | sanitizeHtml"></div>
        </div>
        }

        <!-- Composer with mention autocomplete -->
        <div class="mt-2 form-control relative">
          <textarea
            #taskComposer
            [(ngModel)]="newComment"
            placeholder="Add a comment"
            class="textarea textarea-bordered w-full"
            (input)="onComposerInput($event)"
            (keydown)="onComposerKeydown($event)"
            (click)="onComposerClick($event)"
          ></textarea>
          @if (mc.open() && mc.candidates().length) {
          <div class="absolute left-0 right-0 mt-1 max-h-48 overflow-auto bg-base-100 border border-base-300 rounded shadow z-20">
            @for (u of mc.candidates(); track u.id; let i = $index) {
            <div
              class="px-3 py-2 cursor-pointer flex items-center gap-2"
              [class.bg-base-200]="i === mc.index()"
              (mousedown)="selectMention(u, $event)"
            >
              <div class="w-6 h-6 rounded-full bg-base-300 text-base-content grid place-items-center text-xs font-semibold">
                {{ (u.first_name || u.email || '?') | slice:0:1 }}
              </div>
              <div class="truncate">
                <div class="text-sm font-medium">{{ userDisplay(u) }}</div>
                <div class="text-xs text-base-content/60">{{ u.email }}</div>
              </div>
            </div>
            }
          </div>
          }
          <div class="mt-2 flex items-center justify-end gap-2">
            <button type="button" class="btn btn-sm" (click)="newComment = ''">Clear</button>
            <button type="button" class="btn btn-sm btn-primary" (click)="addComment()" [disabled]="!newComment || isLoading()">Add Comment</button>
          </div>
        </div>
      </div>
      }
    </div>

    <div class="grid gap-2">
      <div class="flex items-center gap-2 select-none">
        <div class="divider flex-1">Attachments ({{ attachments().length }})</div>
        <button class="btn btn-ghost btn-xs" (click)="showAttachments.set(!showAttachments())">
          @if (showAttachments()) { Hide } @else { Show }
        </button>
      </div>
      @if (showAttachments()) {
      <div class="grid gap-2">
        @for (a of attachments(); track a.id) {
        <div class="p-3 border border-base-300 rounded flex items-center justify-between gap-3">
          <div>
            <div class="font-medium">{{ a.filename }}</div>
            <div class="text-xs text-base-content/60">
              {{ a.content_type }} â€¢ {{ a.size_bytes || 0 | number }} bytes
            </div>
          </div>
          @if (a.url) {
          <a class="btn btn-ghost btn-sm" [href]="a.url" target="_blank">Open</a>
          }
        </div>
        }
      </div>
      <div class="flex gap-2">
        <input class="input" placeholder="Filename" [(ngModel)]="attName" />
        <input class="input grow" placeholder="URL (optional)" [(ngModel)]="attUrl" />
        <button class="btn btn-primary" (click)="addAttachment()" [disabled]="!attName || isLoading()">Add</button>
      </div>
      }
    </div>
  </div>
</div>

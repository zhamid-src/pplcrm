<div class="p-2 space-y-3">
  @for (comment of comments(); track comment.id) {
  <div
    class="chat group"
    [class.chat-start]="comment.author_id === myUserId()"
    [class.chat-end]="comment.author_id !== myUserId()"
  >
    <!-- avatar -->
    <div class="chat-image avatar">
      <div class="w-8 h-8 rounded-full bg-base-300 text-base-content !grid place-items-center leading-none">
        <span class="text-xs font-medium uppercase"> {{ (getUserName(comment.author_id) || '?') | slice:0:1 }} </span>
      </div>
    </div>

    <!-- header -->
    <div class="chat-header flex items-center text-xs">
      <span class="font-medium">{{ getUserName(comment.author_id) }}</span>

      @if (comment.created_at) {
      <span class="text-gray-500 tooltip cursor-pointer" [attr.data-tip]="comment.created_at | date:'medium'">
        {{ comment.created_at | timeAgo:{ thresholdDays: 7, style: 'long' } }}
      </span>
      }

      <span class="flex-1"></span>

      <!-- Options menu (hover-reveal on md+, always visible on mobile) -->
      @if (canDelete(comment)) {
      <button
        class="hidden group-hover:flex hover:text-error hover:font-bold cursor-pointer tooltip tooltip-left"
        data-tip="Delete comment"
        (click)="confirmDelete(comment)"
      >
        <pc-icon name="x-mark" [size]="4"></pc-icon>
      </button>

      }
    </div>

    <!-- bubble -->
    <div class="chat-bubble" [innerHTML]="comment.comment | mentionify:users() | sanitizeHtml"></div>
  </div>
  }

  <!-- Composer -->
  <div class="mt-4 form-control relative">
    <textarea
      #emailComposer
      [(ngModel)]="newComment"
      placeholder="Add a comment"
      class="textarea textarea-bordered w-full"
      (input)="onComposerInput($event)"
      (keydown)="onComposerKeydown($event)"
      (click)="onComposerClick($event)"
    ></textarea>
    @if (mc.open() && mc.candidates().length) {
    <div class="absolute left-0 right-0 mt-1 max-h-48 overflow-auto bg-base-100 border border-base-300 rounded shadow z-20">
      @for (u of mc.candidates(); track u.id; let i = $index) {
      <div
        class="px-3 py-2 cursor-pointer flex items-center gap-2"
        [class.bg-base-200]="i === mc.index()"
        (mousedown)="selectMention(u, $event)"
      >
        <div class="w-6 h-6 rounded-full bg-base-300 text-base-content grid place-items-center text-xs font-semibold">
          {{ (u.first_name || u.email || '?') | slice:0:1 }}
        </div>
        <div class="truncate">
          <div class="text-sm font-medium">{{ userDisplay(u) }}</div>
          <div class="text-xs text-base-content/60">{{ u.email }}</div>
        </div>
      </div>
      }
    </div>
    }
    <div class="mt-2 flex items-center justify-end gap-2">
      <button type="button" class="btn btn-sm" (click)="newComment = ''">Clear</button>
      <button type="button" class="btn btn-sm btn-primary" (click)="addComment()">Add Comment</button>
    </div>
  </div>
</div>
